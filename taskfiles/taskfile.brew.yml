version: '3'

includes:
  helper: "./taskfile.helper.yml"

vars:
  BREWDIR: "{{.ROOT_DIR}}/installation/macos"

silent: true

tasks:

  default:
    internal: true
    desc: Default
    cmds:
      - |
        echo "Working dir: {{.USER_WORKING_DIR}}"
        echo "OS: {{OS}}"
        task --list
    silent: true

  assert:
    internal: true
    cmds:
      - task: helper:assert
        vars:
          REQUIRED_TOOLS: brew

  setup:
    desc: Install brew and packages
    internal: true
    platforms: [darwin]
    cmds:
      - task: install
      - task: brewfile

  refresh:
    deps: [assert]
    desc: Upgrade and update brew and packages
    platforms: [darwin]
    cmds:
      - brew upgrade
      - brew update
      - task: brewfile

  doctor:
    deps: [assert]
    desc: Modify common configuration
    internal: true
    platforms: [darwin]
    cmds:
      - brew doctor

  install:
    desc: Install brew minimal setup
    deps: [assert]
    internal: true
    platforms: [darwin]
    status:
      - command -v brew
    cmds:
      - "{{.BREWDIR}}/minimal-setup.sh"

  brewfile:
    desc: Install brew from file
    platforms: [darwin]
    preconditions:
      - sh: brew -v
        msg: 'Could not find `brew`'
    cmds:
      - "brew bundle --file {{.BREWDIR}}/Brewfile"
      - task: doctor
